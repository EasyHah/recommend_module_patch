<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appflow Chat SDK ç‹¬ç«‹æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .debug-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Appflow Chat SDK ç‹¬ç«‹æµ‹è¯•</h1>
        
        <div class="config-section">
            <h3>ğŸ“‹ é…ç½®ä¿¡æ¯</h3>
            <div class="input-group">
                <label for="integrateId">Integrate ID:</label>
                <input type="text" id="integrateId" placeholder="ä¾‹å¦‚: cit-44fd57644e264fecabe0" 
                       value="cit-44fd57644e264fecabe0">
            </div>
            <div class="input-group">
                <label for="requestDomain">Request Domain:</label>
                <input type="text" id="requestDomain" placeholder="ä¾‹å¦‚: https://xxxxx.appflow.aliyunnest.com" 
                       value="https://1677039950952251.appflow.aliyunnest.com">
            </div>
        </div>

        <div id="status" class="status info">
            â³ å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»åˆå§‹åŒ–æŒ‰é’®å¼€å§‹æµ‹è¯•
        </div>

        <div>
            <button onclick="initializeSDK()">ğŸš€ åˆå§‹åŒ– SDK</button>
            <button onclick="initChatUI()" disabled id="initChatBtn">ğŸ¨ åˆå§‹åŒ–èŠå¤©ç•Œé¢</button>
            <button onclick="showChatWindow()" disabled id="showBtn">ğŸ’¬ æ˜¾ç¤ºèŠå¤©çª—å£</button>
            <button onclick="sendTestMessage()" disabled id="sendBtn">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button onclick="getSDKInfo()">â„¹ï¸ è·å– SDK ä¿¡æ¯</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
            <div id="logArea" class="log-area">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <div class="debug-section">
            <h3>ğŸ”§ è°ƒè¯•è¯´æ˜</h3>
            <ul>
                <li><strong>æ­£ç¡®æµç¨‹</strong>ï¼šåˆå§‹åŒ– SDK â†’ åˆå§‹åŒ–èŠå¤©ç•Œé¢ â†’ å‘é€æ¶ˆæ¯</li>
                <li><strong>SDK æ–¹æ³•</strong>ï¼šå®é™…å¯ç”¨æ–¹æ³•åŒ…æ‹¬ initChat, setUser, initTicket ç­‰</li>
                <li><strong>400 é”™è¯¯</strong>ï¼šæœåŠ¡ç«¯æ‹’ç»è¯·æ±‚ï¼Œæ£€æŸ¥ integrateIdã€åŸŸåã€å‘å¸ƒçŠ¶æ€</li>
                <li><strong>ReadableStream é”™è¯¯</strong>ï¼š400 é”™è¯¯çš„è¿å¸¦ç—‡çŠ¶ï¼Œå…ˆè§£å†³ 400</li>
                <li><strong>CORS é”™è¯¯</strong>ï¼šåŸŸåç™½åå•é—®é¢˜æˆ–æµ‹è¯•åŸŸåè¿‡æœŸ</li>
                <li><strong>Network é¢æ¿</strong>ï¼šæŸ¥çœ‹å…·ä½“è¯·æ±‚å“åº”ï¼Œç‰¹åˆ«æ˜¯ 400 çš„å“åº”ä½“</li>
                <li><strong>æ§åˆ¶å°æ£€æŸ¥</strong>ï¼šç¡®ä¿ AppFlow é›†æˆå·²å‘å¸ƒä¸”åŸŸåæœ‰æ•ˆ</li>
            </ul>
        </div>
    </div>

    <!-- Appflow Chat SDK -->
    <script src="https://o.alicdn.com/appflow/chatbot/v1/AppflowChatSDK.js"></script>
    
    <script>
        let isSDKReady = false;
        
        // æ—¥å¿—è¾“å‡º
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const prefix = {
                'success': 'âœ…',
                'error': 'âŒ', 
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            logArea.textContent += `[${now}] ${prefix} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`${prefix} ${message}`);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            document.getElementById('initChatBtn').disabled = !isSDKReady;
            document.getElementById('showBtn').disabled = !isSDKReady;
            document.getElementById('sendBtn').disabled = !isSDKReady;
        }

        // åˆå§‹åŒ– SDK
        async function initializeSDK() {
            const integrateId = document.getElementById('integrateId').value.trim();
            const requestDomain = document.getElementById('requestDomain').value.trim();
            
            if (!integrateId || !requestDomain) {
                updateStatus('âŒ è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
                log('é…ç½®ä¿¡æ¯ä¸å®Œæ•´', 'error');
                return;
            }

            log('å¼€å§‹åˆå§‹åŒ– Appflow Chat SDK...', 'info');
            updateStatus('â³ æ­£åœ¨åˆå§‹åŒ– SDK...', 'info');

            try {
                // æ£€æŸ¥ SDK æ˜¯å¦åŠ è½½
                if (!window.APPFLOW_CHAT_SDK) {
                    throw new Error('SDK è„šæœ¬æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }

                log(`é…ç½®ä¿¡æ¯: integrateId=${integrateId}, domain=${requestDomain}`, 'info');

                const config = {
                    integrateConfig: {
                        integrateId: integrateId,
                        domain: {
                            requestDomain: requestDomain
                        }
                    }
                };

                // åˆå§‹åŒ– SDK
                await window.APPFLOW_CHAT_SDK.init(config);
                
                isSDKReady = true;
                updateButtons();
                updateStatus('âœ… SDK åˆå§‹åŒ–æˆåŠŸï¼å¯ä»¥å¼€å§‹æµ‹è¯•èŠå¤©åŠŸèƒ½', 'success');
                log('SDK åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è¾“å‡ºå¯ç”¨æ–¹æ³•
                const methods = Object.keys(window.APPFLOW_CHAT_SDK).filter(key => 
                    typeof window.APPFLOW_CHAT_SDK[key] === 'function'
                );
                log(`SDK å¯ç”¨æ–¹æ³•: ${methods.join(', ')}`, 'info');

            } catch (error) {
                isSDKReady = false;
                updateButtons();
                updateStatus('âŒ SDK åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œ', 'error');
                log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                
                // è¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (error.message.includes('400')) {
                    log('400 é”™è¯¯é€šå¸¸è¡¨ç¤ºï¼š1) integrateId ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒ 2) requestDomain ä¸åŒ¹é… 3) æµ‹è¯•åŸŸåè¿‡æœŸ', 'warning');
                }
            }
        }

        // åˆå§‹åŒ–èŠå¤©ç•Œé¢
        async function initChatUI() {
            if (!isSDKReady) {
                log('SDK æœªå°±ç»ªï¼Œæ— æ³•åˆå§‹åŒ–èŠå¤©ç•Œé¢', 'error');
                return;
            }

            try {
                log('å¼€å§‹åˆå§‹åŒ–èŠå¤©ç•Œé¢...', 'info');
                
                if (typeof window.APPFLOW_CHAT_SDK.initChat === 'function') {
                    await window.APPFLOW_CHAT_SDK.initChat();
                    log('âœ… èŠå¤©ç•Œé¢åˆå§‹åŒ–æˆåŠŸï¼åº”è¯¥ä¼šçœ‹åˆ°èŠå¤©æ‚¬æµ®çª—', 'success');
                    updateStatus('âœ… èŠå¤©ç•Œé¢å·²åˆå§‹åŒ–ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°æ‚¬æµ®çª—', 'success');
                } else {
                    log('initChat æ–¹æ³•ä¸å­˜åœ¨', 'error');
                }
            } catch (error) {
                log(`åˆå§‹åŒ–èŠå¤©ç•Œé¢å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message.includes('400')) {
                    log('âŒ 400 é”™è¯¯è¯´æ˜æœåŠ¡ç«¯æ‹’ç»äº†è¯·æ±‚ï¼Œè¯·æ£€æŸ¥:', 'error');
                    log('1. é›†æˆæ˜¯å¦å·²åœ¨ AppFlow æ§åˆ¶å°å‘å¸ƒ', 'warning');
                    log('2. integrateId æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥ä»æ§åˆ¶å°å¤åˆ¶ï¼‰', 'warning');
                    log('3. requestDomain æ˜¯å¦ä¸æ§åˆ¶å°ä¸€è‡´', 'warning');
                    log('4. æµ‹è¯•åŸŸåæ˜¯å¦å·²è¿‡æœŸï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰', 'warning');
                }
            }
        }

        // æ˜¾ç¤ºèŠå¤©çª—å£
        async function showChatWindow() {
            if (!isSDKReady) {
                log('SDK æœªå°±ç»ªï¼Œæ— æ³•æ˜¾ç¤ºèŠå¤©çª—å£', 'error');
                return;
            }

            try {
                log('å°è¯•æ˜¾ç¤ºèŠå¤©çª—å£...', 'info');
                
                // æ ¹æ®å®é™…å¯ç”¨æ–¹æ³•è°ƒç”¨
                if (typeof window.APPFLOW_CHAT_SDK.initChat === 'function') {
                    log('è°ƒç”¨ initChat æ–¹æ³•åˆå§‹åŒ–èŠå¤©ç•Œé¢...', 'info');
                    await window.APPFLOW_CHAT_SDK.initChat();
                    log('èŠå¤©ç•Œé¢åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else if (typeof window.APPFLOW_CHAT_SDK.show === 'function') {
                    await window.APPFLOW_CHAT_SDK.show();
                    log('èŠå¤©çª—å£å·²æ˜¾ç¤º', 'success');
                } else {
                    log('æ²¡æœ‰æ‰¾åˆ° initChat æˆ– show æ–¹æ³•ï¼Œå°è¯•å…¶ä»–æ–¹æ³•...', 'warning');
                    const methods = Object.keys(window.APPFLOW_CHAT_SDK).filter(key => 
                        typeof window.APPFLOW_CHAT_SDK[key] === 'function'
                    );
                    log('å¯ç”¨æ–¹æ³•: ' + methods.join(', '), 'info');
                    
                    // å°è¯•å…¶ä»–å¯èƒ½çš„æ–¹æ³•
                    if (typeof window.APPFLOW_CHAT_SDK.open === 'function') {
                        await window.APPFLOW_CHAT_SDK.open();
                        log('ä½¿ç”¨ open æ–¹æ³•æ˜¾ç¤ºèŠå¤©çª—å£', 'success');
                    }
                }
            } catch (error) {
                log(`æ˜¾ç¤ºèŠå¤©çª—å£å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœæ˜¯ 400 é”™è¯¯ï¼Œç»™å‡ºå…·ä½“å»ºè®®
                if (error.message.includes('400')) {
                    log('400 é”™è¯¯å¯èƒ½åŸå› ï¼š1) é›†æˆæœªå‘å¸ƒ 2) åŸŸåä¸åŒ¹é… 3) integrateId é”™è¯¯', 'warning');
                }
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage() {
            if (!isSDKReady) {
                log('SDK æœªå°±ç»ªï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
                return;
            }

            const testMessage = "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œè¯·å›å¤ç¡®è®¤æ”¶åˆ°";
            
            try {
                log(`å‡†å¤‡å‘é€æµ‹è¯•æ¶ˆæ¯: ${testMessage}`, 'info');
                
                // å°è¯•ä¸åŒçš„å‘é€æ–¹æ³•
                if (typeof window.APPFLOW_CHAT_SDK.sendMessage === 'function') {
                    log('ä½¿ç”¨ sendMessage æ–¹æ³•...', 'info');
                    await window.APPFLOW_CHAT_SDK.sendMessage(testMessage);
                    log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else if (typeof window.APPFLOW_CHAT_SDK.send === 'function') {
                    log('ä½¿ç”¨ send æ–¹æ³•...', 'info');
                    await window.APPFLOW_CHAT_SDK.send(testMessage);
                    log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else {
                    log('âŒ æ²¡æœ‰æ‰¾åˆ°å‘é€æ¶ˆæ¯çš„æ–¹æ³•', 'error');
                    const methods = Object.keys(window.APPFLOW_CHAT_SDK).filter(key => 
                        typeof window.APPFLOW_CHAT_SDK[key] === 'function'
                    );
                    log('å½“å‰å¯ç”¨æ–¹æ³•: ' + methods.join(', '), 'info');
                    log('ğŸ’¡ æç¤ºï¼šå¯èƒ½éœ€è¦å…ˆè°ƒç”¨ initChat åˆå§‹åŒ–èŠå¤©ç•Œé¢', 'warning');
                }
            } catch (error) {
                log(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message.includes('ReadableStream')) {
                    log('âš ï¸ ReadableStream é”™è¯¯é€šå¸¸æ˜¯ 400 é”™è¯¯çš„è¿å¸¦ç—‡çŠ¶', 'warning');
                    log('ğŸ’¡ å»ºè®®ï¼šå…ˆè§£å†³ 400 é”™è¯¯ï¼ŒReadableStream é”™è¯¯ä¼šè‡ªåŠ¨æ¶ˆå¤±', 'info');
                } else if (error.message.includes('400')) {
                    log('âš ï¸ 400 é”™è¯¯è¡¨ç¤ºæœåŠ¡ç«¯æ‹’ç»è¯·æ±‚', 'warning');
                    log('ğŸ” è¯·æ£€æŸ¥æµè§ˆå™¨ Network é¢æ¿ä¸­çš„è¯·æ±‚è¯¦æƒ…', 'info');
                }
            }
        }

        // è·å– SDK ä¿¡æ¯
        function getSDKInfo() {
            if (!window.APPFLOW_CHAT_SDK) {
                log('SDK æœªåŠ è½½', 'error');
                return;
            }

            log('=== SDK ä¿¡æ¯ ===', 'info');
            log(`SDK å¯¹è±¡å­˜åœ¨: ${!!window.APPFLOW_CHAT_SDK}`, 'info');
            
            const methods = Object.keys(window.APPFLOW_CHAT_SDK).filter(key => 
                typeof window.APPFLOW_CHAT_SDK[key] === 'function'
            );
            log(`å¯ç”¨æ–¹æ³• (${methods.length}): ${methods.join(', ')}`, 'info');
            
            const properties = Object.keys(window.APPFLOW_CHAT_SDK).filter(key => 
                typeof window.APPFLOW_CHAT_SDK[key] !== 'function'
            );
            log(`å±æ€§ (${properties.length}): ${properties.join(', ')}`, 'info');
            
            if (window.APPFLOW_CHAT_SDK.version) {
                log(`ç‰ˆæœ¬: ${window.APPFLOW_CHAT_SDK.version}`, 'info');
            }
            
            log('=== ç»“æŸ ===', 'info');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logArea').textContent = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // ç›‘å¬ SDK äº‹ä»¶
        window.addEventListener('appflowChatReady', (event) => {
            log('æ”¶åˆ° appflowChatReady äº‹ä»¶: ' + JSON.stringify(event.detail), 'success');
        });

        window.addEventListener('appflowChatMessage', (event) => {
            log('æ”¶åˆ° appflowChatMessage äº‹ä»¶: ' + JSON.stringify(event.detail), 'info');
        });

        window.addEventListener('appflowChatError', (event) => {
            log('æ”¶åˆ° appflowChatError äº‹ä»¶: ' + JSON.stringify(event.detail), 'error');
        });

        window.addEventListener('appflowChatVisibilityChange', (event) => {
            log('èŠå¤©çª—å£å¯è§æ€§å˜åŒ–: ' + JSON.stringify(event.detail), 'info');
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒSDK è„šæœ¬çŠ¶æ€: ' + (window.APPFLOW_CHAT_SDK ? 'å·²åŠ è½½' : 'æœªåŠ è½½'), 'info');
            
            // ç­‰å¾… SDK åŠ è½½
            if (!window.APPFLOW_CHAT_SDK) {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.APPFLOW_CHAT_SDK) {
                        clearInterval(checkInterval);
                        log('SDK è„šæœ¬åŠ è½½å®Œæˆ', 'success');
                    } else if (attempts > 20) {
                        clearInterval(checkInterval);
                        log('SDK è„šæœ¬åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                        updateStatus('âŒ SDK è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    }
                }, 500);
            }
        });

        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            log(`å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`, 'error');
        });

        // æ•è·æœªå¤„ç†çš„ Promise é”™è¯¯
        window.addEventListener('unhandledrejection', (event) => {
            log(`æœªå¤„ç†çš„ Promise é”™è¯¯: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>