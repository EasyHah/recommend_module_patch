# 天气功能集成配置说明

## 环境变量配置

为了使天气功能正常工作，需要在项目根目录创建 `.env.local` 文件并添加以下环境变量：

```bash
# 和风天气API密钥
VITE_QWEATHER_KEY=你的和风天气API密钥

# 高德地图API配置（如果尚未配置）
VITE_AMAP_KEY=你的高德地图API密钥
VITE_AMAP_SECURITY=你的高德地图安全密钥
```

## API 密钥获取方式

### 和风天气API
1. 访问 [和风天气开发平台](https://dev.qweather.com/)
2. 注册账号并创建应用
3. 获取 API Key
4. 将 Key 添加到 `VITE_QWEATHER_KEY` 环境变量

### 高德地图API
1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册开发者账号
3. 创建应用并获取 Key 和安全密钥
4. 分别添加到对应的环境变量

## 功能特性

### 1. 3D天气可视化
- **温度分布图层**：显示各省份实时温度，支持颜色渐变显示
- **预警标记**：在3D地图上显示天气预警信息
- **图层控制**：可独立开关不同天气图层
- **透明度调节**：支持调整天气图层的显示透明度

### 2. 智能推荐增强
- **天气影响评分**：将天气因素纳入供应商推荐算法
- **风险等级评估**：根据天气条件评估物流风险等级
- **天气适应性标签**：为推荐结果添加天气相关标签
- **建议措施**：提供针对性的天气应对建议

### 3. 专业天气分析页面
- **全国天气概览**：实时显示各省份天气状况
- **路径天气分析**：分析特定路径的天气风险
- **实时预警信息**：显示气象部门发布的预警
- **物流建议系统**：提供专业的物流应对建议

## 性能优化措施

### 1. 数据缓存
- 天气数据缓存30分钟，减少API调用
- 图层数据缓存，避免重复渲染
- 省份天气数据批量获取，提高效率

### 2. 渲染优化
- 按需渲染天气图层，未开启时不加载
- 使用 Cesium 的按需渲染模式
- 天气图标使用 Canvas 动态生成，减少资源占用

### 3. 错误处理
- 天气服务异常时自动降级到基础推荐算法
- API 调用失败时提供友好的错误提示
- 网络异常时使用缓存数据

## 使用指南

### 1. 启用天气功能
在推荐系统中勾选"智能天气分析"开关即可启用天气增强推荐。

### 2. 查看天气图层
在3D地图右上角的图层面板中，勾选"天气图层"相关选项。

### 3. 天气分析页面
访问 `/weather` 路径可查看详细的天气分析信息。

### 4. 路径天气评估
在路径规划页面规划路线后，推荐系统会自动考虑天气因素。

## 故障排除

### 1. 天气数据无法加载
- 检查 `VITE_QWEATHER_KEY` 环境变量是否正确配置
- 确认API密钥是否有效且未超出调用限制
- 检查网络连接是否正常

### 2. 3D天气图层不显示
- 确认已开启"天气图层"开关
- 检查浏览器控制台是否有JavaScript错误
- 尝试刷新页面重新加载

### 3. 推荐结果无天气信息
- 确认已开启"智能天气分析"
- 检查起终点是否位于支持的地理范围内
- 查看浏览器控制台的错误信息

## 技术架构

### 服务层
- `weather.ts` - 和风天气API集成服务
- `disaster.ts` - 灾害预警和风险评估服务

### 算法层
- `enhancedRecommendScore.ts` - 增强的推荐算法，集成天气因素

### UI层
- `MapView.vue` - 3D地图天气图层可视化
- `RecommendSidebar.vue` - 天气增强的推荐界面
- `WeatherAnalysis.vue` - 专业天气分析页面

### 类型定义
- `weather.ts` - 完整的天气相关TypeScript类型定义

## 扩展建议

### 1. 功能增强
- 添加历史天气数据分析
- 集成更多气象数据源
- 支持自定义天气预警阈值
- 添加天气趋势预测

### 2. 可视化增强
- 支持动态天气动画
- 添加风场流线显示
- 集成卫星云图数据
- 支持多时间段天气对比

### 3. 算法优化
- 机器学习优化天气影响权重
- 历史数据训练预测模型
- 多因素综合风险评估
- 个性化天气敏感度设置